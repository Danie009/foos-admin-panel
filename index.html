<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Foosball Admin Panel UI - Themed</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="https://i.postimg.cc/ryn27ksN/cropped-circle-image.png" sizes="32x32" />
<style>
/* --- THEME COLOR VARIABLES (Light Mode) --- */
:root {
    --background: #f5f5f7; 
    --foreground: #1c1c1c; 
    --card: #ffffff; 
    --primary: #9a00ff; 
    --primary-foreground: #ffffff; 
    --destructive: #ff4d4f; 
    --destructive-foreground: #ffffff;
    --muted: #ececf0; 
    --muted-foreground: #717182; 
    --border: rgba(0, 0, 0, 0.1); 
    --input-background: #f3f3f5; 
    --radius: 0.625rem; 
}

/* --- BASE STYLES --- */
body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
    padding: 20px; 
    margin: 0; 
    background: var(--background); 
    color: var(--foreground); 
}
h2 { color: var(--foreground); font-size: 24px; margin-bottom: 20px; display: flex; align-items: center; }
h3 { font-size: 16px; font-weight: 600; color: var(--foreground); margin-top: 0; margin-bottom: 10px; }
label { font-size: 14px; font-weight: 500; color: var(--foreground); display: block; margin-top: 10px; margin-bottom: 5px; }

/* --- GRID LAYOUT --- */
#adminPanel { display: none; max-width: 1200px; margin: auto; }
.main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }

/* --- CARD STYLES --- */
.card { 
    background: var(--card); 
    border-radius: var(--radius); 
    padding: 20px; 
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); 
}
.card.data-management { 
    background: #fef4f4; 
    border: 1px solid #f09393; 
}

/* --- INPUTS & BUTTONS --- */
input[type=number] { 
    padding: 10px; 
    margin-bottom: 10px; 
    width: 100%; 
    box-sizing: border-box; 
    border-radius: calc(var(--radius) / 2); 
    border: 1px solid var(--border); 
    font-size: 14px; 
    background: var(--input-background);
    color: var(--foreground);
}

/* --- SELECT CUSTOM STYLES (MATCHES INPUTS) --- */
.select-wrapper {
    position: relative;
    margin-bottom: 10px;
    width: 100%;
    box-sizing: border-box;
}

.select-wrapper select { 
    padding: 10px; 
    width: 100%; 
    box-sizing: border-box; 
    border-radius: calc(var(--radius) / 2); 
    border: 1px solid var(--border); 
    font-size: 14px; 
    background: var(--input-background);
    color: var(--foreground);
    
    /* Remove default OS appearance */
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    cursor: pointer;
    padding-right: 30px; /* Make space for the custom arrow */
}

/* Custom Arrow Icon using CSS */
.select-wrapper::after {
    content: "▼";
    position: absolute;
    top: 50%;
    right: 12px;
    transform: translateY(-50%) scale(0.6); /* Scale the arrow down */
    pointer-events: none; /* Allows click to pass through to the select element */
    color: var(--muted-foreground);
    font-size: 16px;
    line-height: 1;
}

.btn { 
    padding: 12px; 
    border: none; 
    border-radius: calc(var(--radius) / 2); 
    cursor: pointer; 
    font-size: 14px; 
    font-weight: 600; 
    width: 100%; 
    margin-top: 10px; 
    transition: all 0.2s ease-in-out; 
}

/* --- PRIMARY BUTTON (Gradient) --- */
.btn-primary { 
    color: var(--primary-foreground); 
    background: linear-gradient(to right, #a855f7, #ec4899); 
}
.btn-primary:hover { 
    background: linear-gradient(to right, #9333ea, #db2777); 
}

.btn-danger { 
    background: var(--destructive); 
    color: var(--destructive-foreground); 
    margin-top: 15px; 
}
.btn-danger:hover { 
    background: #cc0000; 
}
.btn-outline-danger { 
    background: transparent; 
    color: var(--destructive); 
    border: 1px solid var(--destructive); 
    margin-top: 8px; 
}
.btn-outline-danger:hover { 
    background: #ff4d4f10; 
}

/* --- STATS LIST --- */
.stats-list { margin-top: 15px; }
.player-stat-row { 
    display: grid; 
    grid-template-columns: 50px 1fr repeat(3, 60px); 
    align-items: center; 
    padding: 10px 0; 
    border-bottom: 1px solid var(--border); 
    font-size: 14px; 
}
.player-stat-row:last-child { border-bottom: none; }

/* --- PLAYER INITIALS (Gradient Circle) --- */
.player-initial { 
    width: 32px; 
    height: 32px; 
    border-radius: 50%; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    color: white; 
    font-weight: bold; 
    font-size: 16px; 
    margin-right: 10px; 
    background: linear-gradient(to bottom right, #a855f7, #ec4899);
}

.player-name-container { 
    display: flex; 
    align-items: center; 
    font-weight: 600; 
    color: var(--foreground);
    grid-column: 2; 
}
.stat-label { font-size: 10px; color: var(--muted-foreground); text-transform: uppercase; margin-top: 3px; }
.stat-value { font-weight: bold; color: var(--foreground); }
.stat-header { 
    display: grid; 
    grid-template-columns: 50px 1fr repeat(3, 60px); 
    padding: 5px 0; 
    font-weight: 600; 
    color: var(--muted-foreground); 
    border-bottom: 2px solid var(--border); 
    margin-bottom: 5px; 
    font-size: 12px;
}
.stat-header div:nth-child(3), .stat-header div:nth-child(4), .stat-header div:nth-child(5) {
    text-align: center;
}

/* --- TOP PERFORMER BADGE --- */
.top-performer { 
    background: var(--muted); 
    color: var(--primary); 
    padding: 2px 6px; 
    border-radius: 4px; 
    font-size: 10px; 
    font-weight: 700; 
    margin-left: 10px; 
}

/* --- WARNING BOX --- */
.warning-box {
    margin-top: 20px; 
    padding: 10px; 
    background: var(--muted); 
    border-radius: calc(var(--radius) / 2); 
    font-size: 13px; 
    color: var(--muted-foreground);
    border: 1px solid var(--border);
}

/* --- AUTH CONTAINER --- */
.auth-container { max-width: 350px; margin: 100px auto; padding: 30px; background: var(--card); border-radius: var(--radius); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
.auth-container input { margin-bottom: 15px; }

/* --- TOAST STYLES --- */
#toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; }
.toast-message { min-width: 250px; background-color: #333; color: white; text-align: center; border-radius: 4px; padding: 12px 20px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); opacity: 0; transition: opacity 0.5s; }
.toast-message.show { opacity: 1; }
.toast-error { background-color: #d9534f; }

@media (max-width: 768px) {
    .main-grid { grid-template-columns: 1fr; }
}
#adminPassword{
 padding: 10px; 
            margin-bottom: 15px; 
            width: 100%; 
            box-sizing: border-box; 
            border-radius: 0.3125rem; /* ~calc(var(--radius) / 2) */
            border: 1px solid rgba(0, 0, 0, 0.1); /* var(--border) */
            font-size: 14px; 
            background: #f3f3f5; /* var(--input-background) */
            color: #1c1c1c; /* var(--foreground) */
            height: 40px; /* Ensures a consistent height similar to the select/number inputs */
}
</style>
<script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
</head>
<body>

<div id="toast-container"></div>

<div class="auth-container" id="authContainer">
    <h2>Admin Login</h2>
    <input 
        type="password" 
        id="adminPassword" 
        placeholder="Enter Admin Password"
    >
    <button class="btn btn-primary" onclick="authenticateAdmin()">Login</button>
    <p style="font-size: 12px; text-align: center; color: var(--muted-foreground);">**Warning: Password is client-side only.**</p>
</div>

<div class="admin-container" id="adminPanel">
    <h2>Foosball Admin Control Panel</h2>

    <div class="main-grid">
        <div class="left-column">
            <div class="card" style="margin-bottom: 20px;">
                <h3>Select Week to Edit</h3>
                <p style="color: var(--muted-foreground); font-size: 14px; margin-top: -5px; margin-bottom: 15px;">Choose the week you want to manage.</p>
                
                <div class="select-wrapper">
                    <select id="weekSelector" onchange="loadWeeksFromFirebase(false)"></select>
                </div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3>Current Calculated Stats</h3>
                    <div id="matchesCountDisplay" style="color: var(--primary); font-weight: bold; font-size: 14px;"></div>
                </div>
                
                <div class="stats-list">
                    <div class="stat-header">
                        <div></div>
                        <div>Player</div>
                        <div>Wins</div>
                        <div>Losses</div>
                        <div>Games</div>
                    </div>
                    <div id="playerStatsList">
                        </div>
                </div>

                <div class="warning-box">
                    Note: Admin updates override calculated values in the DB, but the player app must be updated to read the overrides upon page load.
                </div>
            </div>
        </div>

        <div class="right-column">
            <div class="card" style="margin-bottom: 20px;">
                <h3>Manual Stat Adjustment</h3>
                <p style="color: var(--muted-foreground); font-size: 14px; margin-top: -5px; margin-bottom: 15px;">Adjust wins/losses for the selected player.</p>

                <label for="playerSelector">Select Player</label>
                
                <div class="select-wrapper">
                    <select id="playerSelector"></select>
                </div>

                <label for="newWins">New Win Count (e.g., 5.0)</label>
                <input type="number" id="newWins" placeholder="Enter new win count" step="0.5">
                
                <label for="newLosses">New Loss Count (e.g., 3)</label>
                <input type="number" id="newLosses" placeholder="Enter new loss count">
                
                <p style="color: var(--muted-foreground); font-size: 12px; margin-top: 15px;">Note: This bypasses match history and applies to the selected week only.</p>
                <button class="btn btn-primary" onclick="updatePlayerStats()">Update Player Stats</button>
            </div>
            
            <div class="card data-management">
                <h3>⚠️ Data Management</h3>
                <p style="color: var(--destructive); font-size: 14px; margin-top: -5px; margin-bottom: 15px;">Dangerous operations - use with caution</p>

                <button class="btn btn-outline-danger" onclick="deleteLastMatchConfirmation()">Delete Last Match (Current Week)</button>
                <button class="btn btn-danger" onclick="resetAllHistoryConfirmation()">Reset ALL History (DANGER!)</button>
            </div>
        </div>
    </div>
</div>

<script>
// ===========================================
//             CONFIGURATION SECTION
// ===========================================

// ⚠️ 1. CHANGE THIS TO YOUR ADMIN PASSWORD
const ADMIN_PASS = "admin123"; 

// ⚠️ 2. REPLACE THE PLACEHOLDERS WITH YOUR FIREBASE CONFIG
const firebaseConfig = {
    apiKey: "AIzaSyB19QiECHId3sQjB7of1p1OFoN2FGgHEtA", // Replace with your apiKey
    databaseURL: "https://foosball-bae9c-default-rtdb.firebaseio.com", // Replace with your databaseURL
    // ... add any other necessary config fields (authDomain, projectId, etc.)
};

const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Player list must match your data exactly
const allPlayers = [
    "Joseph", "Allan", "Isaac", "Timothy", "Daniel",
    "Ethan", "Mabonga", "IVAN", "Robert", "Shadrach", "Joel"
];

let weeks = []; 
let currentSelectedWeek = null; 

// ===========================================
//             UTILITY FUNCTIONS
// ===========================================

function showToast(message, isError = false) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast-message';
    if (isError) toast.classList.add('toast-error');
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => { toast.classList.add('show'); }, 10);
    setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => toast.remove());
    }, 3000);
}

// ===========================================
//             AUTHENTICATION & SETUP
// ===========================================

function authenticateAdmin() {
    const password = document.getElementById('adminPassword').value;
    if (password === ADMIN_PASS) {
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'grid';
        loadWeeksFromFirebase(true); 
    } else {
        showToast("Authentication failed.", true);
    }
}

// Function to load all weeks and their match history
function loadWeeksFromFirebase(populateSelectorsOnLoad = false) {
    const selectedWeekNum = document.getElementById('weekSelector') ? document.getElementById('weekSelector').value : null;

    db.ref('weeks').once('value').then(snapshot => {
        const data = snapshot.val();
        weeks = [];

        for(let key in data){
            if (key.startsWith('week_')) {
                const weekNum = parseInt(key.replace('week_',''));
                const weekMatches = data[key] && data[key].matches ? Object.entries(data[key].matches).map(([key, val]) => ({id: key, ...val})) : [];
                weeks.push({weekNumber: weekNum, matchHistory: weekMatches});
            }
        }
        
        weeks.sort((a, b) => a.weekNumber - b.weekNumber);

        if(weeks.length === 0) {
            weeks.push({weekNumber: 1, matchHistory: []});
        }
        
        if (populateSelectorsOnLoad) {
            populateSelectors(selectedWeekNum);
        }
        
        const finalSelectedWeekNum = selectedWeekNum || (weeks.length > 0 ? weeks[weeks.length - 1].weekNumber : 1);
        currentSelectedWeek = weeks.find(w => w.weekNumber == finalSelectedWeekNum) || weeks[0];

        updatePlayerStatsDisplay();
    }).catch(error => {
        console.error("Error loading data:", error);
        showToast("Error loading data. Check Firebase config and security rules.", true);
    });
}

// Function to populate the dropdown menus
function populateSelectors(previousSelection = null) {
    const weekSelector = document.getElementById('weekSelector');
    weekSelector.innerHTML = '';

    weeks.forEach(w => {
        const option = document.createElement('option');
        option.value = w.weekNumber;
        option.textContent = `Week ${w.weekNumber}`;
        weekSelector.appendChild(option);
    });
    
    const defaultSelection = previousSelection || weeks[weeks.length - 1].weekNumber;
    if (defaultSelection) {
        weekSelector.value = defaultSelection;
    }

    const playerSelector = document.getElementById('playerSelector');
    if (playerSelector.options.length === 0) {
        allPlayers.forEach(p => {
            const option = document.createElement('option');
            option.value = p;
            option.textContent = p;
            playerSelector.appendChild(option);
        });
    }
}

// ===========================================
//             STATS AND UI DISPLAY
// ===========================================

function updatePlayerStatsDisplay() {
    if (!currentSelectedWeek) return;
    
    const matches = currentSelectedWeek.matchHistory;
    
    // --- Stats Calculation ---
    let stats = {};
    allPlayers.forEach(p => stats[p] = { wins: 0.0, losses: 0, games: 0 });

    matches.forEach(m => {
        const winValue = m.winValue !== undefined ? m.winValue : 1.0;
        
        m.team1.forEach(p => { 
            stats[p].games++;
            if (m.winner === "Team 1") stats[p].wins += winValue;
            else stats[p].losses++;
        });
        m.team2.forEach(p => { 
            stats[p].games++;
            if (m.winner === "Team 2") stats[p].wins += winValue;
            else stats[p].losses++;
        });
    });

    let statArray = Object.entries(stats).map(([player,rec])=>({player,...rec}));
    
    statArray.sort((a,b)=>{ 
      if(b.wins!==a.wins) return b.wins - a.wins;      
      if(a.losses!==b.losses) return a.losses-b.losses; 
      return b.games-a.games;                           
    });

    // --- Rendering UI ---
    const listDiv = document.getElementById('playerStatsList');
    listDiv.innerHTML = '';
    document.getElementById('matchesCountDisplay').textContent = `${matches.length} matches this week`;

    statArray.forEach((r, index) => {
        const isTopPerformer = (index === 0 && r.wins > 0 && (statArray.length === 1 || r.wins > statArray[1].wins));

        listDiv.innerHTML += `
            <div class="player-stat-row">
                <div class="player-initial">${r.player.charAt(0)}</div>
                <div class="player-name-container">
                    ${r.player}
                    ${isTopPerformer ? '<span class="top-performer">Top Performer</span>' : ''}
                </div>
                <div style="text-align: center;">
                    <span class="stat-value">${r.wins.toFixed(1)}</span>
                    <div class="stat-label">Wins</div>
                </div>
                <div style="text-align: center;">
                    <span class="stat-value">${r.losses}</span>
                    <div class="stat-label">Losses</div>
                </div>
                <div style="text-align: center;">
                    <span class="stat-value">${r.games}</span>
                    <div class="stat-label">Games</div>
                </div>
            </div>`;
    });
}

// ===========================================
//             DATA ACTIONS
// ===========================================

// Manually update player win/loss counts
function updatePlayerStats() {
    const player = document.getElementById('playerSelector').value;
    const newWinsInput = document.getElementById('newWins').value;
    const newLossesInput = document.getElementById('newLosses').value;
    const selectedWeekNum = currentSelectedWeek.weekNumber;

    if (!player) { showToast("Select a player.", true); return; }
    
    const newWins = parseFloat(newWinsInput);
    const newLosses = parseInt(newLossesInput);

    if (isNaN(newWins) || isNaN(newLosses) || newWins < 0 || newLosses < 0) {
        showToast("Enter valid non-negative numbers for Wins and Losses.", true);
        return;
    }

    const playerRef = db.ref(`weeks/week_${selectedWeekNum}/stats/${player}`);

    playerRef.update({
        wins: newWins,
        losses: newLosses
    }).then(() => {
        showToast(`Manually updated ${player}'s stats in Week ${selectedWeekNum}. Wins: ${newWins.toFixed(1)}, Losses: ${newLosses}.`);
    }).catch(error => {
        console.error("Firebase update failed:", error);
        showToast("Failed to update stats.", true);
    });
}

// Confirm and delete the last match played in the current week
function deleteLastMatchConfirmation() {
    if (!currentSelectedWeek) return showToast("No week selected.", true);
    if (confirm(`Are you sure you want to delete the MOST RECENT match from Week ${currentSelectedWeek.weekNumber}? This is irreversible.`)) {
        deleteLastMatch();
    }
}

function deleteLastMatch() {
    const selectedWeekNum = currentSelectedWeek.weekNumber;
    
    if (currentSelectedWeek.matchHistory.length === 0) {
        showToast("No matches to delete in this week.", true);
        return;
    }

    const lastMatch = currentSelectedWeek.matchHistory[currentSelectedWeek.matchHistory.length - 1];
    const lastMatchId = lastMatch.id;

    const matchRef = db.ref(`weeks/week_${selectedWeekNum}/matches/${lastMatchId}`);
    
    matchRef.remove().then(() => {
        showToast(`Match ID: ${lastMatchId} deleted from Week ${selectedWeekNum}. Stats will be recalculated.`);
        loadWeeksFromFirebase(true); 
    }).catch(error => {
        console.error("Firebase deletion failed:", error);
        showToast("Failed to delete last match.", true);
    });
}

// Confirm and delete ALL history
function resetAllHistoryConfirmation() {
    if (confirm("DANGER: This will delete the ENTIRE 'weeks' node from Firebase. Are you ABSOLUTELY SURE?")) {
        db.ref('weeks').remove().then(() => {
            showToast("ALL Foosball history has been PERMANENTLY DELETED.", true);
            loadWeeksFromFirebase(true);
        }).catch(error => {
            console.error("Firebase reset failed:", error);
            showToast("Failed to reset all history.", true);
        });
    }
}

// Init on load
window.onload = () => {
    // The panel waits for authentication, so no immediate action needed on load.
};
</script>

</body>
</html>
